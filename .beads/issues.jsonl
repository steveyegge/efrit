{"id":"ef-02f","title":"Fresh clone: bd should suggest 'bd init' when no database exists","description":"On a fresh clone of a repo using beads, running `bd stats` or `bd list` gives a cryptic error:\n\n```\nError: failed to open database: post-migration validation failed: migration invariants failed:\n  - required_config_present: required config key missing: issue_prefix (database has 2 issues)\n```\n\n**Expected**: A helpful message like:\n```\nNo database found. This appears to be a fresh clone.\nRun 'bd init --prefix \u003cprefix\u003e' to hydrate from the committed JSONL file.\nFound: .beads/beads.jsonl (38 issues)\n```\n\n**Why this matters**: The current UX is confusing for new contributors or fresh clones. The happy path should be obvious.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-27T19:51:12.477732-08:00","updated_at":"2025-11-27T20:20:48.687424-08:00","closed_at":"2025-11-27T20:20:48.687424-08:00"}
{"id":"ef-0mp","title":"Review and potentially delete deprecated/ files","description":"The lisp/deprecated/ directory contains 11 files totaling ~4,800 lines:\n\n- efrit-async.el.deprecated (742 lines)\n- efrit-chat-streamlined.el.deprecated (469 lines)\n- efrit-chat.el.deprecated (760 lines)\n- efrit-context.el.deprecated (411 lines)\n- efrit-dashboard.el.deprecated (417 lines)\n- efrit-performance.el.deprecated (386 lines)\n- efrit-progress.el.deprecated (386 lines)\n- efrit-protocol.el.deprecated (170 lines)\n- efrit-session-tracker.el.deprecated (313 lines)\n- efrit-session.el.deprecated (548 lines)\n- efrit-unified.el.deprecated (200 lines)\n\n**Questions to answer:**\n1. Is anything still referencing these?\n2. Has any useful code not been migrated?\n3. Should we keep for historical reference or delete?\n\n**Recommendation:** After verifying no references, delete. Git history preserves them if needed.","status":"open","priority":4,"issue_type":"chore","created_at":"2025-11-28T13:14:03.85887-08:00","updated_at":"2025-11-28T13:14:03.85887-08:00"}
{"id":"ef-0x6","title":"search_content returns empty results - ripgrep not finding matches","description":"During dogfood testing, search_content returns zero matches for patterns that definitely exist in the codebase.\n\nExample: Searching for 'defun efrit-execute' in /Users/stevey/src/efrit returns:\n{\"success\":true,\"result\":{\"matches\":[],\"total_fetched\":0,\"returned\":0,\"offset\":0,\"files_searched\":0,\"truncated\":false,\"search_tool\":\"ripgrep\"}}\n\nNote: files_searched=0 indicates the tool may not be searching any files at all.\n\nThe function definitely exists in lisp/core/efrit-executor.el.\n\nThis is a P1 bug because code search is essential for efrit-do to explore codebases.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T22:41:55.71288-08:00","updated_at":"2025-11-27T22:47:51.572733-08:00","closed_at":"2025-11-27T22:47:51.572733-08:00"}
{"id":"ef-1it","title":"Create efrit-agent.el core module with mode definition","description":"## Summary\nCreate the foundational `efrit-agent.el` module with the major mode definition and basic buffer structure.\n\n## Requirements\n1. Create `lisp/interfaces/efrit-agent.el` with proper headers\n2. Define `efrit-agent-mode` derived from `special-mode`\n3. Create buffer-local variables for session state tracking\n4. Define basic keymap with placeholder bindings\n5. Add to build system (Makefile dependencies)\n\n## Acceptance Criteria\n- [ ] File compiles without warnings (`make compile`)\n- [ ] Mode can be activated in a buffer\n- [ ] `efrit-agent-mode-map` is defined\n- [ ] Buffer-local variables: `efrit-agent--session-id`, `efrit-agent--command`, `efrit-agent--status`\n- [ ] `provide` and `require` statements correct\n\n## Technical Notes\n```elisp\n(define-derived-mode efrit-agent-mode special-mode \"Efrit-Agent\"\n  \"Major mode for Efrit agentic sessions.\"\n  (setq-local truncate-lines nil)\n  (setq-local word-wrap t))\n```\n\n## Dependencies\nNone (first task in epic)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T00:38:00.201577-08:00","updated_at":"2025-11-27T00:46:59.043321-08:00","closed_at":"2025-11-27T00:46:59.043321-08:00"}
{"id":"ef-1jp","title":"Add multi-session project continuity","description":"Currently each efrit-do session starts fresh. For larger projects, need:\n\n- Save/restore session state\n- Continue where you left off\n- Remember what files were modified\n- Track project-level context across sessions\n\n## Implementation Plan (lightweight v1)\n\n**Storage**: JSON files in `~/.emacs.d/.efrit/sessions/`\n\nFormat:\n```json\n{\n  \"id\": \"session-uuid\",\n  \"created_at\": \"2025-11-28T10:30:00Z\",\n  \"updated_at\": \"2025-11-28T11:45:00Z\", \n  \"project_dir\": \"/Users/stevey/src/efrit\",\n  \"message_count\": 87,\n  \"snippet\": \"First user message truncated...\",\n  \"messages\": [...]\n}\n```\n\n**Commands**:\n- `efrit-list-sessions` - completing-read with annotations (snippet, time ago, message count)\n- `efrit-resume-session` - Pick session, inject messages as conversation history\n\n**Implementation steps**:\n1. Add auto-save logic to efrit-do session completion\n2. Create list/resume UI with completing-read\n3. Modify efrit-do to accept prior messages for context injection\n4. Filter by project directory (current vs all)","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-11-27T00:10:15.924643-08:00","updated_at":"2025-11-28T11:50:59.146951-08:00","closed_at":"2025-11-28T11:50:59.146951-08:00"}
{"id":"ef-1rc","title":"search_content parser fails when json-key-type is bound to string","description":"The efrit-tool-search--parse-rg-output function uses alist-get with symbol keys like 'type, but when called from within the API response handler context, json-key-type is bound to 'string by the outer JSON parsing code.\n\nThis causes the parser's let-binding:\n  (let* ((json-object-type 'alist) ...)\nto still use string keys (because json-key-type isn't rebound), making all the alist-get calls return nil.\n\nFix: Add (json-key-type nil) or (json-key-type 'symbol) to the let binding in efrit-tool-search--parse-rg-output.\n\nLocation: lisp/tools/efrit-tool-search-content.el:106\n\nThis is a P1 because it completely breaks code search functionality.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T22:47:46.000861-08:00","updated_at":"2025-11-27T22:48:22.760237-08:00","closed_at":"2025-11-27T22:48:22.760237-08:00"}
{"id":"ef-1vc","title":"Claude doesn't use todo_write for multi-step tasks","description":"When given a multi-step task (e.g., create 3 functions), Claude executes it all in one eval_sexp call rather than using todo_write to track progress.\n\nExample task: 'Create lisp/core/efrit-utils.el with three functions: 1) truncate-string, 2) count-words, 3) pluralize. Make sure it compiles.'\n\nExpected: Claude should use todo_write to track:\n- Create efrit-utils-truncate-string\n- Create efrit-utils-count-words  \n- Create efrit-utils-pluralize\n- Verify compilation\n\nActual: Claude wrote all code in one eval_sexp (2 steps total: 1 eval_sexp + 1 session_complete)\n\nThe system prompt may need stronger guidance about when to use todo_write.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-28T12:30:39.00943-08:00","updated_at":"2025-11-28T12:44:20.404825-08:00","closed_at":"2025-11-28T12:44:20.404825-08:00"}
{"id":"ef-29l","title":"Create documentation index/TOC","description":"The project has 29 markdown documentation files scattered across:\n- Root: README.md, CLAUDE.md, ARCHITECTURE.md, etc.\n- docs/: QUICK_START_GUIDE.md, design/, investigations/\n- plans/: ROADMAP.md, TESTING-PLAN.md\n\n**Problem:** No central index to help users/contributors find relevant docs.\n\n**Action:** Create docs/INDEX.md with:\n1. Categorized list of all docs\n2. Brief description of each\n3. Suggested reading order for different audiences (users, contributors, AI agents)","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-28T13:14:46.463895-08:00","updated_at":"2025-11-28T13:14:46.463895-08:00"}
{"id":"ef-37o","title":"Epic: Documentation Refresh","description":"","status":"open","priority":3,"issue_type":"epic","created_at":"2025-11-28T13:13:21.702112-08:00","updated_at":"2025-11-28T13:13:21.702112-08:00","dependencies":[{"issue_id":"ef-37o","depends_on_id":"ef-pi8","type":"blocks","created_at":"2025-11-28T13:15:41.112905-08:00","created_by":"daemon"},{"issue_id":"ef-37o","depends_on_id":"ef-ccp","type":"blocks","created_at":"2025-11-28T13:15:41.140284-08:00","created_by":"daemon"},{"issue_id":"ef-37o","depends_on_id":"ef-29l","type":"blocks","created_at":"2025-11-28T13:15:41.167149-08:00","created_by":"daemon"},{"issue_id":"ef-37o","depends_on_id":"ef-3c6","type":"blocks","created_at":"2025-11-28T13:15:41.193255-08:00","created_by":"daemon"}]}
{"id":"ef-3c6","title":"Consolidate scattered planning documents","description":"Planning/design docs are scattered:\n- plans/ROADMAP.md (307 lines)\n- plans/TESTING-PLAN.md (510 lines)\n- docs/design/context-budget-management.md (402 lines)\n- docs/designs/efrit-agent-buffer-design.md (185 lines)\n- docs/mcp-implementation-plan.md (252 lines)\n- docs/mcp-server-design.md (194 lines)\n- docs/design-todo-system.md (259 lines)\n\n**Questions:**\n1. Which plans are still active vs completed?\n2. Should completed designs be archived?\n3. Should active plans be in one place?\n\n**Recommendation:** Review each, archive completed ones, consolidate active ones.","status":"open","priority":4,"issue_type":"chore","created_at":"2025-11-28T13:14:47.732204-08:00","updated_at":"2025-11-28T13:14:47.732204-08:00"}
{"id":"ef-3i7","title":"Update system prompt with TodoWrite guidance","description":"Update efrit-do--command-system-prompt and efrit-do--session-protocol-instructions to guide Claude on using todo_write.\n\n## Changes\n\nReplace all references to the 8 old tools with todo_write guidance:\n- Remove: todo_analyze, todo_add, todo_update, todo_status, todo_next, todo_execute_next, todo_get_instructions, todo_complete_check\n- Add: todo_write with clear when-to-use guidance\n\n## Guidance Pattern (from Claude Code)\n\n```\nUse todo_write when:\n- Complex multi-step tasks (3+ steps)\n- User provides multiple tasks\n- Breaking down large features\n\nDo NOT use for:\n- Simple single-action tasks\n- Trivial operations\n- Pure information queries\n```\n\n## Key changes\n\n1. efrit-do--session-protocol-instructions: simplify dramatically\n2. Remove all anti-loop messaging (no longer needed)\n3. Remove workflow state references\n\n## Acceptance\n\n- [ ] System prompt references todo_write not old tools\n- [ ] Clear when-to-use / when-not-to-use guidance\n- [ ] No anti-loop warnings in prompt","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-26T22:22:06.093655-08:00","updated_at":"2025-11-26T22:38:47.687923-08:00","closed_at":"2025-11-26T22:38:47.687923-08:00","dependencies":[{"issue_id":"ef-3i7","depends_on_id":"ef-v2y","type":"blocks","created_at":"2025-11-26T22:23:07.933483-08:00","created_by":"daemon"}]}
{"id":"ef-441","title":"bd doctor should detect fresh clone and recommend 'bd init'","description":"When running `bd doctor` on a fresh clone (JSONL exists, no .db file), it should:\n\n1. Detect this is a fresh clone situation\n2. Recommend `bd init --prefix \u003cdetected-prefix\u003e` as the fix\n3. Show the prefix detected from the JSONL file\n\nCurrently it shows various warnings (git hooks, merge driver, etc.) but doesn't address the fundamental issue: the database needs to be hydrated.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T19:51:18.669904-08:00","updated_at":"2025-11-27T20:20:48.688768-08:00","closed_at":"2025-11-27T20:20:48.688768-08:00"}
{"id":"ef-50o","title":"Consolidate duplicate truncation functions","description":"Found 7 implementations of string truncation logic scattered across the codebase:\n\n1. efrit-common.el:214 - efrit-common-truncate-string (main function)\n2. efrit-progress.el:218 - efrit-progress--truncate (identical logic)\n3. efrit-budget.el:341 - efrit-budget--truncate-list (similar logic)\n4. efrit-ui.el:1348 - efrit-modeline--truncate (identical to progress)\n5. efrit-tool-search-content.el:89 - efrit-tool-search--truncate-line (similar)\n6. efrit-do.el:2346 - buffer truncation\n7. efrit-do.el:2661 - another buffer truncation\n\n**Action:** All modules should use efrit-common-truncate-string. Remove duplicates.\n\n**Why:** DRY principle - duplicated code leads to inconsistent behavior and maintenance burden.","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-28T13:13:59.879913-08:00","updated_at":"2025-11-28T13:13:59.879913-08:00"}
{"id":"ef-61i","title":"bd doctor --fix needs non-interactive mode (-y/--yes flag)","description":"When running `bd doctor --fix` in non-interactive mode (scripts, CI, Claude Code), it prompts 'Continue? (Y/n):' and fails with EOF.\n\n**Expected**: A `-y` or `--yes` flag to auto-confirm fixes.\n\n**Workaround**: Currently have to run `bd init` instead, but that's not discoverable from the doctor output.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T19:51:04.388119-08:00","updated_at":"2025-11-27T20:20:48.688313-08:00","closed_at":"2025-11-27T20:20:48.688313-08:00"}
{"id":"ef-6gl","title":"efrit-agent: Wire pause/resume/cancel to executor","description":"Lines 237, 247, 256, 335: TODO comments for wiring buttons to efrit-executor-cancel/pause/resume/respond. These are placeholders that need implementation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T01:26:01.079626-08:00","updated_at":"2025-11-27T20:57:27.986577-08:00","closed_at":"2025-11-27T20:57:27.986577-08:00"}
{"id":"ef-6kc","title":"efrit-agent: Fragile TODO vector conversion","description":"Lines 659-674: efrit-agent--convert-todo-item uses hardcoded vector indices (aref todo 0/1/2). If struct changes, silently breaks. Use accessor functions or document expected format.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-27T01:25:45.991507-08:00","updated_at":"2025-11-27T20:52:39.78586-08:00","closed_at":"2025-11-27T20:52:39.78586-08:00"}
{"id":"ef-7no","title":"Update npm dependencies to fix security vulnerabilities","description":"npm audit shows 2 moderate severity vulnerabilities and several deprecated packages:\n\n**Deprecated:**\n- inflight@1.0.6 (leaks memory)\n- @humanwhocodes/config-array@0.13.0 (use @eslint/config-array)\n- rimraf@3.0.2 (versions \u003c4 unsupported)\n- glob@7.2.3 (versions \u003c9 unsupported)\n- @humanwhocodes/object-schema@2.0.3 (use @eslint/object-schema)\n- eslint@8.57.1 (version no longer supported)\n\n**Action:**\n1. Run npm audit fix\n2. Consider updating eslint to v9.x\n3. Update other deprecated packages\n\n**Location:** mcp/package.json","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-11-28T13:14:23.159276-08:00","updated_at":"2025-11-28T14:13:27.04408-08:00","closed_at":"2025-11-28T14:13:27.04408-08:00"}
{"id":"ef-7rn","title":"Epic: Code Health \u0026 Refactoring","description":"","status":"open","priority":2,"issue_type":"epic","created_at":"2025-11-28T13:13:18.132195-08:00","updated_at":"2025-11-28T13:13:18.132195-08:00","dependencies":[{"issue_id":"ef-7rn","depends_on_id":"ef-xng","type":"blocks","created_at":"2025-11-28T13:15:37.225188-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-cji","type":"blocks","created_at":"2025-11-28T13:15:37.260588-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-q4w","type":"blocks","created_at":"2025-11-28T13:15:37.291021-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-50o","type":"blocks","created_at":"2025-11-28T13:15:37.319667-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-83h","type":"blocks","created_at":"2025-11-28T13:15:37.343954-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-0mp","type":"blocks","created_at":"2025-11-28T13:15:37.369087-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-8vp","type":"blocks","created_at":"2025-11-28T13:15:37.394832-08:00","created_by":"daemon"},{"issue_id":"ef-7rn","depends_on_id":"ef-nvi","type":"blocks","created_at":"2025-11-28T13:15:37.417061-08:00","created_by":"daemon"}]}
{"id":"ef-83h","title":"Centralize magic numbers into named constants","description":"Found 36 magic numbers scattered across the codebase, particularly:\n\n**Token budgets (duplicated 3x):**\n- efrit-chat.el:52 - efrit-max-tokens = 8192\n- efrit-config.el:128 - efrit-default-max-tokens = 8192 \n- efrit-do.el:210 - efrit-max-tokens = 8192\n\n**Timeouts (inconsistent values):**\n- 300 seconds: efrit-executor.el, efrit-tool-show-diff-preview.el, efrit-tool-confirm-action.el\n- 30 seconds: efrit-tool-utils.el, efrit-remote-queue.el\n- 15 seconds: efrit-tool-fetch-url.el\n\n**Action:**\n1. Create efrit-constants.el with named constants\n2. Remove duplicate defcustom definitions\n3. Reference constants instead of hardcoded values\n\n**Why:** Scattered magic numbers make it hard to understand system limits and ensure consistency.","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-28T13:14:02.437518-08:00","updated_at":"2025-11-28T13:14:02.437518-08:00"}
{"id":"ef-8vp","title":"Refactor other long functions (\u003e100 lines)","description":"Besides the 491-line efrit-do--budget-warning-prompt, these functions exceed 100 lines:\n\n1. efrit-agent.el:131 - efrit-agent--char (207 lines)\n2. efrit-tools.el:595 - efrit-tools-system-prompt (203 lines)\n3. efrit-ui.el:1033 - efrit-show-metrics (164 lines)\n4. efrit-executor.el:177 - efrit-executor--handle-response (160 lines)\n5. efrit-executor.el:548 - efrit-execute (159 lines)\n6. efrit-do.el:2233 - efrit-do--command-system-prompt (105 lines)\n\n**Pattern:** Most are prompt builders or display functions. Consider:\n- Breaking into smaller helpers\n- Using template strings or files\n- Separating data from formatting\n\n**Priority:** Lower than the 491-line function, but still worth addressing.","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-28T13:15:05.670295-08:00","updated_at":"2025-11-28T13:15:05.670295-08:00"}
{"id":"ef-8zp","title":"Implement input section for user interaction","description":"## Summary\nImplement the input section allowing users to interact with the session.\n\n## Requirements\n1. Detect when session is waiting for user input\n2. Show the question being asked by Claude\n3. Provide completion options if applicable\n4. Standard editing with submit/cancel bindings\n5. Support mid-session guidance injection\n\n## Acceptance Criteria\n- [ ] Input area appears when session waits for user\n- [ ] Question text displayed above input\n- [ ] `C-c C-s` submits input\n- [ ] `C-c C-c` cancels/aborts\n- [ ] Completion works for multiple-choice questions\n- [ ] Injected guidance appears in activity section\n\n## Design\n```\nâ”â”â” Input â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nQuestion: Which authentication method should we use?\nOptions: [OAuth] [JWT] [Session]\n\nType response (C-c C-s to send, C-c C-c to cancel):\n\u003e _\n```\n\n## Technical Notes\n- Wire to `efrit-executor-respond` for submission\n- Use `efrit-progress-inject` for mid-session guidance\n\n## Dependencies\n- Core module task\n- Activity section (to show injected messages)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T00:38:58.550811-08:00","updated_at":"2025-11-27T22:18:52.738894-08:00","closed_at":"2025-11-27T22:18:52.738894-08:00","dependencies":[{"issue_id":"ef-8zp","depends_on_id":"ef-1it","type":"blocks","created_at":"2025-11-27T00:40:15.994343-08:00","created_by":"daemon"},{"issue_id":"ef-8zp","depends_on_id":"ef-sas","type":"blocks","created_at":"2025-11-27T00:40:16.375802-08:00","created_by":"daemon"}]}
{"id":"ef-9hq","title":"efrit-agent: Race condition matching tool results","description":"Lines 728-738: Matches tool result by tool name, not activity ID. If same tool called concurrently (e.g. parallel Grep), wrong activity gets updated. Fix: match by unique activity ID instead.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T01:25:17.081464-08:00","updated_at":"2025-11-27T13:45:37.35421-08:00","closed_at":"2025-11-27T13:45:37.35421-08:00"}
{"id":"ef-9jp","title":"Circuit breaker trips but session keeps calling tools","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-26T20:53:25.214389-08:00","updated_at":"2025-11-26T22:59:30.650305-08:00","closed_at":"2025-11-26T22:59:30.650305-08:00"}
{"id":"ef-9lj","title":"vcs_status rejects ~ paths as sandbox violations","description":"When Claude uses vcs_status with a path like '~/src/efrit', the sandbox validation rejects it even when the path IS the project root.\n\nRoot cause: The path comparison in efrit-tool--path-in-directory-p fails because:\n- expanded-path: /Users/stevey/src/efrit (no trailing slash)\n- expanded-dir: /Users/stevey/src/efrit/ (has trailing slash)\n\nstring-prefix-p returns nil because the directory path with trailing slash is NOT a prefix of the path without trailing slash.\n\nFix: Either:\n1. Use file-name-as-directory on the path being checked (not just the directory), OR\n2. Use file-equal-p for the exact-match case, OR  \n3. Normalize both paths consistently before comparison\n\nLocation: lisp/core/efrit-tool-utils.el:127-132","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-27T22:40:56.780337-08:00","updated_at":"2025-11-27T22:49:39.05798-08:00","closed_at":"2025-11-27T22:49:39.05798-08:00"}
{"id":"ef-9oa","title":"Dogfood Run #8: Build focus-mode.el with Efrit","description":"Manual dogfood test to stress-test Efrit's agentic capabilities.\n\nTest prompt: Build focus-mode.el with text centering, line dimming, word count, and toggle command.\n\nGoals:\n1. Document all pain points encountered\n2. Verify multi-step execution works\n3. Test error recovery\n4. Evaluate UX gaps\n\nThis test will validate or discover new issues for the 'last mile' work.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T00:10:23.692744-08:00","updated_at":"2025-11-27T00:16:01.254727-08:00","closed_at":"2025-11-27T00:16:01.254727-08:00"}
{"id":"ef-9v6","title":"Add test runner with coverage reporting","description":"Current test infrastructure runs tests but doesn't report coverage.\n\n**Current state:**\n- test/efrit-test-runner.el exists but is basic\n- No coverage metrics\n- No per-module coverage tracking\n\n**Desired:**\n- Track which functions are exercised by tests\n- Report uncovered code paths\n- Integrate with CI to fail on coverage regression\n\n**Note:** Elisp coverage tools exist (undercover.el) but may need evaluation.","status":"open","priority":3,"issue_type":"feature","created_at":"2025-11-28T13:15:08.986375-08:00","updated_at":"2025-11-28T13:15:08.986375-08:00"}
{"id":"ef-9yx","title":"Add live tool execution progress display","description":"Currently tool execution happens 'invisibly' - user only sees results after completion. Need real-time feedback showing:\n\n- Which tool is currently executing\n- Tool input parameters (summarized)\n- Elapsed time per tool\n- Running count of tool calls in session\n\nThis should integrate with the *efrit-agent* buffer but could also enhance mode-line feedback.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T00:09:51.392376-08:00","updated_at":"2025-11-27T21:38:20.036994-08:00","closed_at":"2025-11-27T21:38:20.036994-08:00"}
{"id":"ef-a46","title":"session_complete message overwrites tool execution results","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-26T20:53:25.260994-08:00","updated_at":"2025-11-26T22:53:12.565291-08:00","closed_at":"2025-11-26T22:53:12.565291-08:00"}
{"id":"ef-a4w","title":"Add mode line current-task indicator","description":"Show the current in-progress task in the Emacs mode line.\n\n## Display\n\nWhen a task is in_progress, show in mode line:\n```\n[Efrit: Implementing auth module]\n```\n\nWhen no tasks or all complete:\n```\n[Efrit: idle]\n```\n\n## Implementation\n\n1. Add mode-line-format element\n2. Update when todo_write sets a task to in_progress\n3. Truncate long task names (max ~40 chars)\n4. Make it optional (defcustom efrit-show-task-in-modeline)\n\n## Acceptance\n\n- [ ] Mode line shows current task\n- [ ] Updates live when todo_write called\n- [ ] Configurable on/off","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-26T22:22:09.457512-08:00","updated_at":"2025-11-26T23:25:39.365794-08:00","closed_at":"2025-11-26T23:25:39.365794-08:00","dependencies":[{"issue_id":"ef-a4w","depends_on_id":"ef-v2y","type":"blocks","created_at":"2025-11-26T22:23:08.060287-08:00","created_by":"daemon"}]}
{"id":"ef-bhd","title":"efrit-agent: Header re-render every second is inefficient","description":"Line 440: efrit-agent--render-header-only does full buffer re-render. Called every second by timer. Causes cursor flicker. Should implement partial update for elapsed time only.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T01:25:47.401143-08:00","updated_at":"2025-11-27T20:55:53.510321-08:00","closed_at":"2025-11-27T20:55:53.510321-08:00"}
{"id":"ef-bhf","title":"Implement tasks section with TODO integration","description":"## Summary\nImplement the tasks section showing TODO progress from `efrit-do--current-todos`.\n\n## Requirements\n1. Subscribe to TODO updates from efrit-do\n2. Render task list with status indicators:\n   - `âœ“` completed (dimmed)\n   - `â–¶` in-progress (highlighted, with arrow marker)\n   - `â—‹` pending\n3. Show progress summary: \"Tasks (3/5 complete)\"\n4. Update in real-time as tasks progress\n5. Handle empty state gracefully\n\n## Acceptance Criteria\n- [ ] Tasks render correctly from `efrit-do--current-todos`\n- [ ] Current task is visually highlighted\n- [ ] Progress counter updates as tasks complete\n- [ ] Section updates without full buffer redraw\n- [ ] Empty state shows \"No tasks\" or similar\n\n## Design\n```\nâ”â”â” Tasks (3/5 complete) â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  âœ“ Create basic package structure\n  âœ“ Add margin centering functionality  \n  â–¶ Add word count to mode line           â† current\n  â—‹ Test the complete package\n  â—‹ Save to /tmp/focus-mode.el\n```\n\n## Technical Notes\n- Use `advice-add` on `efrit-do--update-todo-status` to trigger updates\n- Consider using text properties for efficient updates\n\n## Dependencies\n- Core module task","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T00:38:58.419327-08:00","updated_at":"2025-11-27T00:50:11.522398-08:00","closed_at":"2025-11-27T00:50:11.522398-08:00","dependencies":[{"issue_id":"ef-bhf","depends_on_id":"ef-1it","type":"blocks","created_at":"2025-11-27T00:40:15.866758-08:00","created_by":"daemon"}]}
{"id":"ef-ccp","title":"Update CHANGELOG.md with recent changes","description":"CHANGELOG.md last entry is [0.3.0] - 2025-11-24.\n\nSince then, significant work has been done:\n- efrit-agent.el added (world-class agentic session buffer)\n- Session transcript persistence\n- Bug fixes (search_content, timer memory leaks, race conditions)\n- Code organization (deprecated files moved)\n\n**Action:** Add [0.3.1] or [0.4.0] entry documenting recent changes.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-28T13:14:45.326173-08:00","updated_at":"2025-11-28T14:16:36.158253-08:00","closed_at":"2025-11-28T14:16:36.158253-08:00"}
{"id":"ef-cji","title":"Split efrit-session.el into focused modules","description":"efrit-session.el has 106 functions in 1700 lines - the highest function count in the codebase. \n\n**Analysis needed:** Review the function groupings to identify natural boundaries. Likely candidates:\n- Session lifecycle (create, start, end, cleanup)\n- Session persistence (save, load, transcript)\n- Session state management\n- Session metrics/statistics\n\n**Why:** 106 functions in one file makes the module hard to understand and test in isolation.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-28T13:13:39.789377-08:00","updated_at":"2025-11-28T13:13:39.789377-08:00"}
{"id":"ef-db3","title":"Fix encoding artifacts in session output","description":"During dogfood run #8, the session output contained encoding artifacts like:\n\n```\n*ERROR*: Unknown message: roperly\u0026_en\n*ERROR*: Unknown message: adding\u0026_tex\n```\n\nThese appear when displaying SESSION-COMPLETE messages with special characters. The underlying functionality works, but the output is garbled.\n\nLikely related to Unicode handling in efrit-progress or efrit-do output formatting.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-27T00:16:11.493069-08:00","updated_at":"2025-11-27T21:13:13.611836-08:00","closed_at":"2025-11-27T21:13:13.611836-08:00"}
{"id":"ef-dc8","title":"Design TodoWrite-style interface for better task tracking","description":"Replace the current 8-tool TODO system with a single TodoWrite-style tool.\n\n## Why\n\nThe current system has:\n- 8 separate tools (todo_add, todo_update, todo_analyze, etc.)\n- Complex anti-loop infrastructure (workflow state machine, tool call counting, schema filtering)\n- Client-side intelligence in todo_analyze (pattern matching on commands)\n- Sync issues from incremental state updates\n\nThe TodoWrite pattern (used by Claude Code) solves these:\n- Single tool, full state replacement each call\n- No sync issues, no loops by design\n- Pure Executor: Efrit just stores what Claude sends\n- Proven pattern Claude already knows\n\n## Scope\n\n- Implement todo_write tool\n- Update system prompt guidance  \n- UI: *efrit-todos* buffer + mode line\n- Delete old tools + anti-loop machinery\n- Update docs\n\n## Out of Scope (separate issues)\n\n- ef-t7f: Response detail lost\n- ef-9jp: Circuit breaker doesn't terminate session\n- ef-a46: session_complete overwrites results","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-26T20:53:25.30635-08:00","updated_at":"2025-11-26T23:31:58.499778-08:00","closed_at":"2025-11-26T23:31:58.499778-08:00"}
{"id":"ef-dn9","title":"Add systematic test coverage for core modules","description":"Current test coverage is ad-hoc. Need systematic coverage for:\n\n**Core modules needing tests:**\n- efrit-executor.el - Has test-comprehensive but no dedicated unit tests\n- efrit-budget.el - Has test-budget-compress but limited coverage\n- efrit-common.el - No dedicated tests\n- efrit-config.el - No dedicated tests\n- efrit-log.el - No dedicated tests\n\n**Tools with good coverage:**\n- efrit-tool-search-content.el âœ“\n- efrit-tool-elisp-docs.el âœ“\n- efrit-tool-vcs-*.el âœ“\n- efrit-tool-checkpoint.el âœ“\n- efrit-tool-project-files.el âœ“\n- efrit-tool-read-file.el âœ“\n\n**Action:** Create test files for uncovered core modules following existing patterns.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-28T13:14:24.872498-08:00","updated_at":"2025-11-28T13:14:24.872498-08:00"}
{"id":"ef-dnf","title":"efrit-agent: Implement expand/collapse for tool details","description":"Lines 579-580: efrit-agent-item-id property set but expanded state never used during rendering. efrit-agent--expanded-items hash table populated but never read. Verbosity setting also unused.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T01:25:48.467041-08:00","updated_at":"2025-11-27T21:32:07.01607-08:00","closed_at":"2025-11-27T21:32:07.01607-08:00"}
{"id":"ef-dpw","title":"Design and implement *efrit-agent* buffer for agentic workflows","description":"Create a dedicated *efrit-agent* buffer for multi-step agentic workflows.\n\n## Design Document\nSee: docs/designs/efrit-agent-buffer-design.md\n\n## Key Features\n- Header with session status (Working/Paused/Waiting/Complete/Failed)\n- Tasks section showing TODO progress with current task highlighted\n- Activity section with collapsible tool call details\n- Input section for user interaction mid-session\n- Real-time updates from efrit-progress events\n\n## Buffer Layout\n```\nâ”Œâ”€ Header: Session ID, Command, Status, Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”œâ”€ Tasks: âœ“ done, â–¶ current, â—‹ pending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”œâ”€ Activity: Tool calls, Claude messages, errors â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ””â”€ Input: User message area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Implementation Phases\n1. Basic structure and mode definition\n2. Live updates via progress events\n3. Task integration with efrit-do TODOs\n4. Input handling for user interaction\n\n## Success Criteria\nUser can see exactly what Efrit is doing at any moment during dogfood tests.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-27T00:09:34.554595-08:00","updated_at":"2025-11-27T00:39:55.079341-08:00","closed_at":"2025-11-27T00:39:55.079341-08:00"}
{"id":"ef-e66","title":"Define comprehensive faces for visual consistency","description":"## Summary\nDefine all faces used in the agent buffer for visual consistency and theme compatibility.\n\n## Requirements\n1. Define faces for all status states\n2. Define faces for task indicators\n3. Define faces for activity items\n4. Ensure faces inherit from standard faces for theme compatibility\n5. Test with light and dark themes\n\n## Faces to Define\n```elisp\n;; Status faces\nefrit-agent-status-working    ; green, maybe bold\nefrit-agent-status-paused     ; yellow\nefrit-agent-status-waiting    ; blue\nefrit-agent-status-complete   ; green\nefrit-agent-status-failed     ; red, maybe bold\n\n;; Task faces\nefrit-agent-task-complete     ; dimmed/gray\nefrit-agent-task-current      ; bold, highlighted\nefrit-agent-task-pending      ; normal\n\n;; Activity faces\nefrit-agent-tool-name         ; inherit from efrit-progress-tool-name\nefrit-agent-claude-message    ; blue\nefrit-agent-error             ; red\nefrit-agent-timestamp         ; gray, smaller\n\n;; UI faces\nefrit-agent-section-header    ; bold\nefrit-agent-button            ; boxed\nefrit-agent-button-hover      ; highlighted\n```\n\n## Acceptance Criteria\n- [ ] All faces defined with proper inheritance\n- [ ] Looks good in default theme\n- [ ] Looks good in popular dark theme (doom-one, dracula)\n- [ ] Looks good in popular light theme (leuven)\n\n## Dependencies\n- Core module","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T00:38:58.748221-08:00","updated_at":"2025-11-27T00:54:12.114397-08:00","closed_at":"2025-11-27T00:54:12.114397-08:00","dependencies":[{"issue_id":"ef-e66","depends_on_id":"ef-1it","type":"blocks","created_at":"2025-11-27T00:40:16.055593-08:00","created_by":"daemon"}]}
{"id":"ef-e8n","title":"Epic: World-class *efrit-agent* buffer for agentic workflows","description":"## Overview\nCreate a best-in-class agentic session buffer that makes Efrit feel like working WITH an intelligent assistant, not waiting for one.\n\n## Vision\nWhen a user runs `efrit-do` with a complex task, they should see:\n- Real-time task progress (not just final results)\n- What Claude is thinking and doing\n- Ability to interrupt, redirect, or provide input\n- Clear error context when things go wrong\n\n## Design Document\nSee: docs/designs/efrit-agent-buffer-design.md\n\n## Success Metrics\n1. During dogfood tests, user can see exactly what Efrit is doing at any moment\n2. Task completion is visible before session ends\n3. Errors are immediately visible with actionable context\n4. User can provide input mid-session without friction\n5. The UX is comparable to Claude Code's terminal experience\n\n## Scope\n- New `efrit-agent.el` module\n- Integration with efrit-progress, efrit-do, efrit-executor\n- New faces and rendering for structured display\n- Key bindings for interaction\n\n## Out of Scope (for now)\n- Multi-session management (separate epic)\n- Mobile/terminal-only rendering\n- Streaming token display","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-11-27T00:37:39.167324-08:00","updated_at":"2025-11-27T22:20:55.880611-08:00","closed_at":"2025-11-27T22:20:55.880611-08:00"}
{"id":"ef-ey1","title":"efrit-agent: O(nÂ²) performance bug in activity list","description":"Line 644-645: push + nreverse on every add is O(n) per add, making total O(nÂ²). For 100 activities this does ~5000 list operations. Fix: append to end or keep reversed and reverse during render.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T01:25:14.911108-08:00","updated_at":"2025-11-27T13:45:37.323795-08:00","closed_at":"2025-11-27T13:45:37.323795-08:00"}
{"id":"ef-fjv","title":"Fix MCP test failure: tsconfig isolatedModules","description":"MCP tests fail with:\n```\nsrc/types.ts:6:43 - error TS2823: Import attributes are only supported when the '--module' option is set to 'esnext', 'node18', 'node20', 'nodenext', or 'preserve'.\n\nimport packageJson from '../package.json' with { type: 'json' };\n```\n\nThe tsconfig.json has module: 'nodenext' which should work, but jest's ts-jest warns:\n'Using hybrid module kind (Node16/18/Next) is only supported in isolatedModules: true'\n\n**Fix:** Add isolatedModules: true to tsconfig.json compilerOptions\n\n**Impact:** MCP tests don't run in CI, blocking validation of MCP changes.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-28T13:14:21.765992-08:00","updated_at":"2025-11-28T14:12:10.064209-08:00","closed_at":"2025-11-28T14:12:10.064209-08:00"}
{"id":"ef-fpf","title":"Session turn limit (30) may be too low for complex multi-step tasks","description":"During dogfooding, a 3-part task (count files, find test files, read README) hit the 30-turn session limit before completing.\n\nThe limit is set in efrit-executor-max-continuations (default 30).\n\nOptions to consider:\n1. Increase the default limit\n2. Make Claude more efficient with fewer API roundtrips (batch tool calls)\n3. Add a way to continue a session that hit the limit\n4. Better guidance in system prompt about efficiency\n\nThis is low priority since most tasks complete within the limit, but complex exploration tasks may need more turns.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-28T10:22:59.674042-08:00","updated_at":"2025-11-28T10:52:41.792907-08:00","closed_at":"2025-11-28T10:52:41.792907-08:00"}
{"id":"ef-gep","title":"Implement header section with status display","description":"## Summary\nImplement the header section showing session info, status, and action buttons.\n\n## Requirements\n1. Render session ID and command summary\n2. Show status with appropriate indicator:\n   - `â— Working` (green) - active execution\n   - `â¸ Paused` (yellow) - user paused\n   - `â³ Waiting` (blue) - awaiting user input\n   - `âœ“ Complete` (green) - session done\n   - `âœ— Failed` (red) - error state\n3. Show elapsed time (updated every second)\n4. Render action buttons: [Cancel] [Pause]\n5. Create faces for each status type\n\n## Acceptance Criteria\n- [ ] Header renders correctly with all components\n- [ ] Status updates when session state changes\n- [ ] Elapsed timer updates every second during active session\n- [ ] Buttons are clickable (mouse-1 binding)\n- [ ] Faces defined: `efrit-agent-status-working`, `efrit-agent-status-complete`, etc.\n\n## Design\n```\nâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\nâ”‚ ğŸ¤– Efrit Agent Session: async-20241127001234            â”‚\nâ”‚ Command: Build focus-mode.el package                     â”‚\nâ”‚ Status: â— Working (3.2s)              [Cancel] [Pause]   â”‚\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\n```\n\n## Dependencies\n- ef-XXX: Core module","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T00:38:58.348349-08:00","updated_at":"2025-11-27T00:48:21.693473-08:00","closed_at":"2025-11-27T00:48:21.693473-08:00","dependencies":[{"issue_id":"ef-gep","depends_on_id":"ef-1it","type":"blocks","created_at":"2025-11-27T00:40:15.803751-08:00","created_by":"daemon"}]}
{"id":"ef-i9h","title":"Bug: read_file tool fails due to string/symbol key mismatch","description":"efrit-do--extract-fields creates alists with string keys like ((\"path\" . \"value\")), but tool functions like efrit-tool-read-file use (alist-get 'path args) with symbol keys. Since alist-get uses eq by default, string keys never match. Fix: convert string keys to symbols in efrit-do--extract-fields using intern.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-26T23:45:52.063633-08:00","updated_at":"2025-11-26T23:46:45.501443-08:00","closed_at":"2025-11-26T23:46:45.501443-08:00"}
{"id":"ef-kyl","title":"Create *efrit-todos* buffer with live display","description":"Create a dedicated buffer showing current TODO state with visual indicators.\n\n## Buffer: *efrit-todos*\n\nDisplay format:\n```\nEfrit Tasks\n===========\n\nâ†’ [IN PROGRESS] Implementing auth module\n  [PENDING] Add unit tests  \n  [PENDING] Update documentation\nâœ“ [COMPLETED] Read existing code\n```\n\n## Implementation\n\n1. Create efrit-todos-mode (read-only, special mode)\n2. Function to render current TODO list\n3. Auto-update when todo_write is called\n4. Color coding: pending=default, in_progress=highlight, completed=dim\n\n## Optional enhancements\n\n- Click to expand task details\n- Timestamp display\n- Progress bar (X of Y complete)\n\n## Acceptance\n\n- [ ] Buffer exists and displays TODO list\n- [ ] Auto-updates on todo_write calls\n- [ ] Visual distinction between states","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T22:22:07.535516-08:00","updated_at":"2025-11-26T23:17:20.978036-08:00","closed_at":"2025-11-26T23:17:20.978036-08:00","dependencies":[{"issue_id":"ef-kyl","depends_on_id":"ef-v2y","type":"blocks","created_at":"2025-11-26T22:23:07.996262-08:00","created_by":"daemon"}]}
{"id":"ef-lxq","title":"Implement comprehensive key bindings and help","description":"## Summary\nImplement all key bindings and a help system for the agent buffer.\n\n## Requirements\n1. Implement all navigation bindings\n2. Implement all action bindings  \n3. Create help display (`?` binding)\n4. Add mouse bindings for buttons\n5. Ensure consistency with Emacs conventions\n\n## Key Bindings\n| Key | Action |\n|-----|--------|\n| `q` | Quit buffer (doesn't cancel session) |\n| `k` | Kill/cancel session |\n| `p` | Pause session |\n| `r` | Resume paused session |\n| `g` | Refresh display |\n| `RET` | Expand/collapse at point |\n| `TAB` | Next section |\n| `S-TAB` | Previous section |\n| `C-c C-s` | Send input |\n| `C-c C-c` | Cancel current operation |\n| `v` | Toggle verbosity |\n| `?` | Show help |\n\n## Acceptance Criteria\n- [ ] All bindings functional\n- [ ] Help buffer shows all bindings\n- [ ] Mouse clicks work on buttons\n- [ ] No conflicts with global bindings\n\n## Dependencies\n- Core module\n- Input section (for send/cancel)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T00:38:58.682527-08:00","updated_at":"2025-11-27T00:54:40.336093-08:00","closed_at":"2025-11-27T00:54:40.336093-08:00","dependencies":[{"issue_id":"ef-lxq","depends_on_id":"ef-1it","type":"blocks","created_at":"2025-11-27T00:40:16.122012-08:00","created_by":"daemon"}]}
{"id":"ef-nvi","title":"Review archived/ files for deletion","description":"The archived/ directory contains 3 old files:\n- efrit-agent.el (560 lines) - Old agent implementation, now replaced by lisp/interfaces/efrit-agent.el\n- efrit-command.el (215 lines) - Old command system\n- efrit-multi-turn.el (320 lines) - Old multi-turn logic\n\n**Question:** Are these still needed or can they be deleted? \n\n**Note:** Different from deprecated/ - these were moved wholesale rather than replaced incrementally.","status":"open","priority":4,"issue_type":"chore","created_at":"2025-11-28T13:15:07.668091-08:00","updated_at":"2025-11-28T13:15:07.668091-08:00"}
{"id":"ef-oom","title":"Surface TODO tracking to user during agentic sessions","description":"Efrit internally tracks TODOs via efrit-do--current-todos but users can't see them during execution. Need:\n\n- Show task breakdown as Claude plans it\n- Visual progress (X of Y tasks complete)\n- Current task highlighted\n- Ability to see what's coming next\n\nThe *efrit-todos* buffer exists but isn't integrated into the agentic workflow visibility.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T00:10:00.042879-08:00","updated_at":"2025-11-27T00:53:25.049376-08:00","closed_at":"2025-11-27T00:53:25.049376-08:00"}
{"id":"ef-pi8","title":"Update STATUS.md to reflect current state","description":"STATUS.md says 'Last Updated: 2025-11-21' - now a week stale.\n\n**Outdated information:**\n- References old issue IDs like 'mcp-bt0' (from old tracker)\n- MCP server status may have changed\n- Test infrastructure status needs update\n- Dashboard status unclear\n\n**Action:** Review all sections and update to current state. This is the 'single source of truth' for project status.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-28T13:14:44.174576-08:00","updated_at":"2025-11-28T14:15:57.500921-08:00","closed_at":"2025-11-28T14:15:57.500921-08:00"}
{"id":"ef-q4w","title":"Refactor efrit-do--budget-warning-prompt (491 lines)","description":"The function efrit-do--budget-warning-prompt at lisp/interfaces/efrit-do.el:378 is 491 lines long - the longest function in the codebase.\n\nThis appears to be a giant string/prompt builder. It should be:\n1. Broken into smaller helper functions\n2. Or moved to a separate prompt template file\n3. Or use a more structured prompt construction approach\n\n**Why:** 491-line functions are impossible to understand, test, or modify safely.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-28T13:13:41.21689-08:00","updated_at":"2025-11-28T13:13:41.21689-08:00"}
{"id":"ef-rg4","title":"Efrit hangs on some multi-step tasks","description":"During dogfood testing, efrit-do hung for 2+ minutes on a task asking to create a file with proper elisp headers. The command was:\n\nefrit-do \"Add a simple function to lisp/core/efrit-utils.el that counts words in a string. Name it efrit-utils-count-words. Make sure the file has proper elisp headers with lexical-binding and a provide statement at the end.\"\n\nThe same task with shorter phrasing worked fine. Need to investigate:\n1. Is this a prompt length issue?\n2. Is there an infinite loop in the executor?\n3. Is the API call timing out silently?\n\nSimpler tasks (2+2, create file with function) work in 10-15 seconds.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-28T12:30:15.593968-08:00","updated_at":"2025-11-28T12:37:05.881947-08:00","closed_at":"2025-11-28T12:37:05.881947-08:00"}
{"id":"ef-sas","title":"Implement activity section with tool call display","description":"## Summary\nImplement the activity section showing tool executions and Claude's messages.\n\n## Requirements\n1. Subscribe to efrit-progress events\n2. Render tool calls with icons and summary:\n   - `ğŸ”§` for tool calls\n   - `ğŸ’¬` for Claude text\n   - `âŒ` for errors\n3. Support expandable/collapsible tool details\n4. Show timestamps relative to session start\n5. Auto-scroll to latest entry (unless user scrolled up)\n\n## Acceptance Criteria\n- [ ] Tool calls appear in real-time during execution\n- [ ] Claude messages displayed with proper formatting\n- [ ] Errors highlighted in red with context\n- [ ] Press RET to expand/collapse tool details\n- [ ] Auto-scroll works correctly\n- [ ] Section doesn't flicker during updates\n\n## Design\n```\nâ”â”â” Activity â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n[00:01] ğŸ”§ eval_sexp â†’ Created buffer *focus-mode-dev*\n[00:03] ğŸ’¬ Claude: \"Now adding word count functionality...\"\n[00:05] ğŸ”§ eval_sexp â†’ ...                    [â–¼ expand]\n[00:07] âŒ Error: void-function foo\n```\n\n## Expanded View\n```\n[00:05] ğŸ”§ eval_sexp                          [â–² collapse]\n        Input: (defun focus-mode--count-words () ...)\n        Result: focus-mode--count-words\n        Time: 0.02s\n```\n\n## Technical Notes\n- Use text properties to store tool-call data for expansion\n- Consider `overlay` for expand/collapse animations\n\n## Dependencies\n- Core module task","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T00:38:58.485665-08:00","updated_at":"2025-11-27T00:51:34.840853-08:00","closed_at":"2025-11-27T00:51:34.840853-08:00","dependencies":[{"issue_id":"ef-sas","depends_on_id":"ef-1it","type":"blocks","created_at":"2025-11-27T00:40:15.934019-08:00","created_by":"daemon"}]}
{"id":"ef-t7f","title":"Response detail is lost - only shows 'Command executed successfully'","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-26T20:53:25.113444-08:00","updated_at":"2025-11-26T22:48:03.77131-08:00","closed_at":"2025-11-26T22:48:03.77131-08:00"}
{"id":"ef-tc5","title":"efrit-agent: Terminal compatibility - unicode/emoji fallbacks","description":"Box-drawing chars (â•­â•®â•°â•¯â”â”€â”‚), emoji (ğŸ’¬âŒâ¸â³), and colors (green3, gold) may not work on all terminals. Consider ASCII fallbacks or defcustom for unicode vs ASCII mode.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-11-27T01:25:59.023856-08:00","updated_at":"2025-11-27T21:35:09.855494-08:00","closed_at":"2025-11-27T21:35:09.855494-08:00"}
{"id":"ef-utf","title":"TODO system not used unless explicitly requested","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-26T20:53:25.163985-08:00","updated_at":"2025-11-26T23:14:23.899893-08:00","closed_at":"2025-11-26T23:14:23.899893-08:00"}
{"id":"ef-v14","title":"Epic: Test Infrastructure Improvements","description":"","status":"open","priority":2,"issue_type":"epic","created_at":"2025-11-28T13:13:20.679982-08:00","updated_at":"2025-11-28T13:13:20.679982-08:00","dependencies":[{"issue_id":"ef-v14","depends_on_id":"ef-fjv","type":"blocks","created_at":"2025-11-28T13:15:39.533481-08:00","created_by":"daemon"},{"issue_id":"ef-v14","depends_on_id":"ef-7no","type":"blocks","created_at":"2025-11-28T13:15:39.562223-08:00","created_by":"daemon"},{"issue_id":"ef-v14","depends_on_id":"ef-dn9","type":"blocks","created_at":"2025-11-28T13:15:39.588328-08:00","created_by":"daemon"},{"issue_id":"ef-v14","depends_on_id":"ef-9v6","type":"blocks","created_at":"2025-11-28T13:15:39.612069-08:00","created_by":"daemon"}]}
{"id":"ef-v2y","title":"Implement todo_write tool (schema + handler + state)","description":"Core implementation of the TodoWrite-style tool.\n\n## Schema\n```json\n{\n  \"name\": \"todo_write\",\n  \"parameters\": {\n    \"todos\": [{\n      \"content\": \"Task in imperative form\",\n      \"status\": \"pending|in_progress|completed\",\n      \"activeForm\": \"Task in present continuous\"\n    }]\n  }\n}\n```\n\n## Implementation\n\n1. Add schema to efrit-do--tools-schema\n2. Add handler to efrit-do--tool-handlers  \n3. Handler stores list in buffer-local or global var\n4. Return success with current state summary\n\n## Key principle\n\nPure Executor: just store what Claude sends. No validation of task content, no state machine, no \"smart\" behavior.\n\n## Acceptance\n\n- [ ] Schema defined and tool appears in API\n- [ ] Handler stores TODO list\n- [ ] Calling todo_write replaces entire list (not incremental)\n- [ ] Returns confirmation with count","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-26T22:21:42.847276-08:00","updated_at":"2025-11-26T22:30:50.599828-08:00","closed_at":"2025-11-26T22:30:50.599828-08:00"}
{"id":"ef-vb8","title":"Claude doesn't follow exact function naming in prompts","description":"When asked to create a function with a specific name, Claude sometimes uses a different name.\n\nExample:\n- Prompt: 'Create lisp/core/efrit-utils.el with a word-count function' \n- Expected: efrit-utils-count-words (following project convention)\n- Actual: efrit-word-count\n\nThis may be a system prompt issue - need to add guidance about following exact naming when specified.\n\nLow priority since it works functionally, just doesn't match spec.","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-11-28T12:30:26.644918-08:00","updated_at":"2025-11-28T12:50:43.41475-08:00","closed_at":"2025-11-28T12:50:43.41475-08:00"}
{"id":"ef-w5f","title":"Remove old TODO tools and anti-loop machinery","description":"Delete the 8 old TODO tools and all associated anti-loop infrastructure.\n\n## Tools to remove\n\nFrom efrit-do--tool-handlers:\n- todo_add\n- todo_update\n- todo_show\n- todo_analyze\n- todo_status\n- todo_next\n- todo_execute_next\n- todo_get_instructions\n- todo_complete_check\n\n## Handlers to delete\n\n- efrit-do--handle-todo-add\n- efrit-do--handle-todo-update\n- efrit-do--handle-todo-show\n- efrit-do--handle-todo-analyze\n- efrit-do--handle-todo-status\n- efrit-do--handle-todo-next\n- efrit-do--handle-todo-execute-next\n- efrit-do--handle-todo-complete-check\n\n## Anti-loop infrastructure to remove\n\n- efrit-do--workflow-state variable\n- efrit-do--tool-call-count variable\n- efrit-do--last-tool-called variable\n- efrit-do--get-current-tools-schema filtering logic (lines 906-952)\n- All LOOP PREVENTION messages embedded in responses\n\n## Keep\n\n- format_todo_list (may still be useful)\n- Basic TODO state storage (used by new todo_write)\n\n## Acceptance\n\n- [ ] Old tool schemas removed from API\n- [ ] Old handlers deleted\n- [ ] Anti-loop state machine removed\n- [ ] Code compiles clean\n- [ ] No references to old tools remain","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T22:22:28.64919-08:00","updated_at":"2025-11-26T23:07:20.718329-08:00","closed_at":"2025-11-26T23:07:20.718329-08:00","dependencies":[{"issue_id":"ef-w5f","depends_on_id":"ef-v2y","type":"blocks","created_at":"2025-11-26T22:23:08.128144-08:00","created_by":"daemon"}]}
{"id":"ef-wns","title":"Improve inline error display during agentic execution","description":"When elisp errors occur during tool execution, they're captured but not displayed in a user-friendly way. Need:\n\n- Show errors inline in the agent buffer, not just in *efrit-do*\n- Include the code that failed\n- Show Claude's retry attempts\n- Make it clear when Claude is trying a different approach\n\nCurrent error handling works functionally but lacks UX polish.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T00:10:07.934985-08:00","updated_at":"2025-11-27T00:53:31.768565-08:00","closed_at":"2025-11-27T00:53:31.768565-08:00"}
{"id":"ef-xng","title":"Split efrit-do.el into focused modules","description":"efrit-do.el is 2869 lines with 98 functions - far too large. The file has clear section markers that suggest natural split points:\n\n**Proposed split:**\n1. efrit-do-circuit-breaker.el - Circuit breaker state \u0026 implementation (lines 253-914)\n2. efrit-do-error-detection.el - Error loop detection (lines 915-1119)  \n3. efrit-do-context.el - Context system \u0026 ring management (lines 1120-1292)\n4. efrit-do-todo.el - TODO management (lines 1199-1282)\n5. efrit-do-tool-handlers.el - Tool handler helpers \u0026 handlers (lines 1435-2137)\n6. efrit-do.el - Core command execution only (remaining ~800 lines)\n\n**Why:** Large files are hard to navigate, test, and maintain. Each concern should have its own module.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-28T13:13:38.083382-08:00","updated_at":"2025-11-28T13:13:38.083382-08:00"}
{"id":"ef-xxf","title":"Create integration tests for efrit-agent buffer","description":"## Summary\nCreate comprehensive tests for the agent buffer functionality.\n\n## Requirements\n1. Unit tests for rendering functions\n2. Integration test with mock session\n3. Test all status transitions\n4. Test with real efrit-do execution (burns tokens)\n\n## Test Cases\n1. Buffer creation and mode activation\n2. Header rendering with all status types\n3. Task section with various TODO states\n4. Activity section with tool calls\n5. Input section interaction\n6. Session lifecycle (start â†’ working â†’ complete)\n7. Error handling (failed session)\n8. User cancellation\n\n## Acceptance Criteria\n- [ ] All unit tests pass\n- [ ] Integration test with mock works\n- [ ] Real token-burning test validates UX\n- [ ] No regressions in efrit-do functionality\n\n## Technical Notes\nCreate `test/test-efrit-agent.el` with ERT tests.\n\n## Dependencies\n- All other agent buffer tasks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T00:38:58.812934-08:00","updated_at":"2025-11-27T22:20:25.60921-08:00","closed_at":"2025-11-27T22:20:25.60921-08:00","dependencies":[{"issue_id":"ef-xxf","depends_on_id":"ef-zzr","type":"blocks","created_at":"2025-11-27T00:40:16.440284-08:00","created_by":"daemon"}]}
{"id":"ef-yj0","title":"Bug: efrit-do uses one-shot execution instead of agentic loop","description":"efrit-do calls efrit-do--execute-command which is one-shot: it sends the command, executes tools once, and returns. It doesn't continue the conversation loop. However, efrit-executor.el has efrit-execute which has a proper while loop that continues until stop_reason is end_turn. efrit-do should use efrit-execute instead of its own one-shot implementation, or add the agentic loop to efrit-do--execute-command.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-26T23:49:16.135373-08:00","updated_at":"2025-11-26T23:53:54.580816-08:00","closed_at":"2025-11-26T23:53:54.580816-08:00"}
{"id":"ef-z80","title":"Update documentation for TodoWrite system","description":"Update all documentation to reflect the new todo_write tool.\n\n## Files to update\n\n- docs/design-todo-system.md - mark as implemented, update with final design\n- CLAUDE.md - update any TODO tool references\n- README.md - if it mentions TODO features\n\n## Changes\n\n- Remove references to 8-tool system\n- Document todo_write schema and usage\n- Update examples to show new pattern\n- Archive or remove obsolete design discussion\n\n## Acceptance\n\n- [ ] No docs reference old TODO tools\n- [ ] todo_write documented with examples\n- [ ] Design doc updated to reflect implementation","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-26T22:22:29.974291-08:00","updated_at":"2025-11-26T23:32:08.224201-08:00","closed_at":"2025-11-26T23:32:08.224201-08:00","dependencies":[{"issue_id":"ef-z80","depends_on_id":"ef-w5f","type":"blocks","created_at":"2025-11-26T22:23:08.196143-08:00","created_by":"daemon"}]}
{"id":"ef-z8g","title":"efrit-agent: Memory leak - timer not cleaned on buffer kill","description":"Line 366-367: efrit-agent--elapsed-timer is created but never cleaned if buffer killed. Add kill-buffer-hook to cancel timer.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-27T01:25:18.298356-08:00","updated_at":"2025-11-27T13:45:37.287598-08:00","closed_at":"2025-11-27T13:45:37.287598-08:00"}
{"id":"ef-zkv","title":"Auto-detect issue prefix from existing JSONL in 'bd init'","description":"When running `bd init` in a fresh clone with existing JSONL, it should auto-detect the issue prefix from the JSONL file instead of requiring `--prefix`.\n\nCurrently you must specify `--prefix ef` manually. But the JSONL file already contains issues like `ef-1it`, `ef-1jp` etc., so the prefix is known.\n\n**Ideal UX**:\n```\n$ bd init\nDetected issue prefix 'ef' from existing JSONL (38 issues).\nâœ“ Database initialized...\n```\n\nThis would make fresh clone hydration a single command: `bd init` with no flags.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-27T19:51:27.286361-08:00","updated_at":"2025-11-27T20:20:48.689157-08:00","closed_at":"2025-11-27T20:20:48.689157-08:00"}
{"id":"ef-zzr","title":"Wire efrit-agent buffer to efrit-do/executor lifecycle","description":"## Summary\nIntegrate the agent buffer with the Efrit execution lifecycle so it automatically appears and updates.\n\n## Requirements\n1. Auto-create buffer when `efrit-do` starts multi-step session\n2. Hook into `efrit-progress-start-session` for initialization\n3. Hook into `efrit-progress-end-session` for completion\n4. Register for progress events (tool-start, tool-result, text)\n5. Handle session cancellation gracefully\n\n## Acceptance Criteria\n- [ ] Buffer appears automatically for complex tasks\n- [ ] Buffer updates in real-time during execution\n- [ ] Buffer shows final status when session ends\n- [ ] Cancelled sessions show appropriate state\n- [ ] No orphaned buffers after session cleanup\n\n## Technical Notes\n```elisp\n;; Hook into session start\n(advice-add 'efrit-progress-start-session :after\n            #'efrit-agent--on-session-start)\n\n;; Or use a hook if we add one to efrit-progress\n(add-hook 'efrit-progress-session-start-hook\n          #'efrit-agent--on-session-start)\n```\n\n## Open Questions\n- Should buffer appear for ALL efrit-do calls or only multi-step?\n  Recommendation: Only when TODO list is created (indicates multi-step)\n\n## Dependencies\n- Core module\n- All section implementations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-27T00:38:58.617279-08:00","updated_at":"2025-11-27T00:52:37.773259-08:00","closed_at":"2025-11-27T00:52:37.773259-08:00","dependencies":[{"issue_id":"ef-zzr","depends_on_id":"ef-gep","type":"blocks","created_at":"2025-11-27T00:40:16.186947-08:00","created_by":"daemon"},{"issue_id":"ef-zzr","depends_on_id":"ef-bhf","type":"blocks","created_at":"2025-11-27T00:40:16.251206-08:00","created_by":"daemon"},{"issue_id":"ef-zzr","depends_on_id":"ef-sas","type":"blocks","created_at":"2025-11-27T00:40:16.313639-08:00","created_by":"daemon"}]}
