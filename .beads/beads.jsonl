{"id":"ef-0ag","title":"Phase 1: Create *efrit-progress* buffer with auto-updating display","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:04:25.779776-08:00","updated_at":"2025-11-24T23:04:25.779776-08:00","dependencies":[{"issue_id":"ef-0ag","depends_on_id":"ef-0ji","type":"blocks","created_at":"2025-11-24T23:05:58.72832-08:00","created_by":"daemon"}]}
{"id":"ef-0ji","title":"Phase 1: Create progress.jsonl file channel for session events","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T23:04:23.915504-08:00","updated_at":"2025-11-24T23:16:22.422165-08:00","closed_at":"2025-11-24T23:16:22.422165-08:00","dependencies":[{"issue_id":"ef-0ji","depends_on_id":"ef-sha","type":"blocks","created_at":"2025-11-24T23:05:58.66201-08:00","created_by":"daemon"}]}
{"id":"ef-0xz","title":"Phase 2: Progress Consumption - External log tailing support","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:04:32.676279-08:00","updated_at":"2025-11-24T23:04:32.676279-08:00","dependencies":[{"issue_id":"ef-0xz","depends_on_id":"ef-0ji","type":"blocks","created_at":"2025-11-24T23:06:00.241765-08:00","created_by":"daemon"}]}
{"id":"ef-1o2","title":"Tier 5: Agent-level challenge tests","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T22:51:25.461699-08:00","updated_at":"2025-11-24T22:51:25.461699-08:00","dependencies":[{"issue_id":"ef-1o2","depends_on_id":"ef-6sv","type":"blocks","created_at":"2025-11-24T22:51:42.691035-08:00","created_by":"daemon"}]}
{"id":"ef-1r6","title":"Testing: Tier 9 - Injection and conversation tests","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T23:05:11.95475-08:00","updated_at":"2025-11-24T23:05:11.95475-08:00","dependencies":[{"issue_id":"ef-1r6","depends_on_id":"ef-gth","type":"blocks","created_at":"2025-11-24T23:06:13.671082-08:00","created_by":"daemon"},{"issue_id":"ef-1r6","depends_on_id":"ef-bxc","type":"blocks","created_at":"2025-11-24T23:06:13.73463-08:00","created_by":"daemon"}]}
{"id":"ef-27c","title":"Testing: Tier 8 - Progress streaming verification tests","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:05:09.903859-08:00","updated_at":"2025-11-24T23:05:09.903859-08:00","dependencies":[{"issue_id":"ef-27c","depends_on_id":"ef-gth","type":"blocks","created_at":"2025-11-24T23:06:13.549349-08:00","created_by":"daemon"},{"issue_id":"ef-27c","depends_on_id":"ef-0ji","type":"blocks","created_at":"2025-11-24T23:06:13.613016-08:00","created_by":"daemon"}]}
{"id":"ef-3go","title":"Update efrit--handle-api-response to send tool results back","description":"In efrit--handle-api-response (efrit-chat.el:646), when tool-results exist: 1) Add assistant message to history, 2) Build user message with tool_result content blocks, 3) Add to history, 4) Call efrit--send-api-request to continue conversation. Only display final response to user after Claude processes tool results.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-24T00:37:37.521052-08:00","updated_at":"2025-11-24T00:58:16.941194-08:00","closed_at":"2025-11-24T00:58:16.941194-08:00","dependencies":[{"issue_id":"ef-3go","depends_on_id":"ef-5af","type":"blocks","created_at":"2025-11-24T00:40:35.857492-08:00","created_by":"daemon"}]}
{"id":"ef-5af","title":"Modify efrit--extract-content-and-tools to return tool results","description":"Change efrit--extract-content-and-tools return value from (cons message-text should-delegate) to (list message-text tool-results should-delegate) where tool-results is a list of tool_result blocks built with efrit--build-tool-result. Collect ALL tool results, not just errors. Location: efrit-chat.el:493-552","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-24T00:37:29.871923-08:00","updated_at":"2025-11-24T00:55:48.462133-08:00","closed_at":"2025-11-24T00:55:48.462133-08:00","dependencies":[{"issue_id":"ef-5af","depends_on_id":"ef-al6","type":"blocks","created_at":"2025-11-24T00:40:35.722329-08:00","created_by":"daemon"},{"issue_id":"ef-5af","depends_on_id":"ef-fub","type":"blocks","created_at":"2025-11-24T00:40:35.789524-08:00","created_by":"daemon"}]}
{"id":"ef-6rw","title":"Identical tool call detection not catching glob_files loops","description":"The circuit breaker's identical-call detection (efrit-do-max-identical-tool-calls=3) is not stopping glob_files loops effectively.\n\n**Evidence from multiple dogfood tests:**\n\nTest 1: 'List all the .el files in /Users/stevey/src/efrit/lisp/core/ and count how many there are'\n- 13 glob_files calls with same input hash before circuit breaker stopped it\n\nTest 2: 'Create a new buffer called *dogfood-test* with a list of all .el files in /Users/stevey/src/efrit/lisp/'  \n- 11 consecutive glob_files calls\n- Circuit breaker never tripped\n- Session had to be manually cancelled\n\n**Root cause analysis:**\n1. The identical call counter appears to be reset between API continuations\n2. Each new continuation starts fresh, so 'identical' count never reaches 3 within a single API call\n3. The circuit breaker only checks within a single response, not across the session\n\n**Real impact:**\n- Simple file listing tasks burn 10-13x more tokens than needed\n- glob_files tool appears broken - Claude keeps retrying it\n- May also indicate glob_files is returning an error that makes Claude retry\n\n**Fix needed:**\n1. Persist identical-call counters across continuations\n2. OR: Track tool call patterns at the session level, not response level\n3. Investigate why glob_files results make Claude want to retry","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T21:11:59.871469-08:00","updated_at":"2025-11-24T22:00:08.645157-08:00","closed_at":"2025-11-24T22:00:08.645157-08:00"}
{"id":"ef-6sv","title":"Manual Testing Plan: Efrit-do-async Agent Capability","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-11-24T22:51:10.734528-08:00","updated_at":"2025-11-24T22:51:10.734528-08:00"}
{"id":"ef-6wy","title":"Phase 1: Progress Emission - Create efrit-progress.el module","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-24T23:04:20.631651-08:00","updated_at":"2025-11-24T23:16:04.61386-08:00","closed_at":"2025-11-24T23:16:04.61386-08:00"}
{"id":"ef-7w9","title":"Streamlined mode uses wrong tool_result format","description":"efrit-streamlined--continue-with-results sends tool results as plain text content instead of proper tool_result blocks. API expects: {type: 'tool_result', tool_use_id: 'xxx', content: '...'} but we send: {role: 'user', content: 'Tool result for xxx: ...'}. Location: efrit-chat.el:854-882","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-24T00:33:40.609606-08:00","updated_at":"2025-11-24T00:38:14.025971-08:00","closed_at":"2025-11-24T00:38:14.025971-08:00","dependencies":[{"issue_id":"ef-7w9","depends_on_id":"ef-rk0","type":"blocks","created_at":"2025-11-24T00:34:09.395909-08:00","created_by":"daemon"}]}
{"id":"ef-7za","title":"Phase 3: Injection Channel - Create inject queue directory and protocol","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:04:42.662925-08:00","updated_at":"2025-11-24T23:04:42.662925-08:00","dependencies":[{"issue_id":"ef-7za","depends_on_id":"ef-tii","type":"blocks","created_at":"2025-11-24T23:06:02.121175-08:00","created_by":"daemon"}]}
{"id":"ef-840","title":"Tier 1: Single-tool smoke tests","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T22:51:19.197168-08:00","updated_at":"2025-11-24T23:32:25.528889-08:00","closed_at":"2025-11-24T23:32:25.528889-08:00","dependencies":[{"issue_id":"ef-840","depends_on_id":"ef-6sv","type":"blocks","created_at":"2025-11-24T22:51:42.449369-08:00","created_by":"daemon"}]}
{"id":"ef-8p7","title":"Improve efrit-tools-system-prompt to teach Claude to read before writing","description":"System prompt SUCCESSFULLY enhanced with read-verify-act pattern.\n\nCHANGES MADE (lisp/core/efrit-tools.el:619-780):\n\n✅ Added CRITICAL RULE #1 at top (lines 622-627)\n   - Visual interrupt with ⚠️ and borders\n   - Explicit: 'ALWAYS read buffer contents BEFORE manipulating'\n   - Repeated 3 times (primacy, middle, recency)\n\n✅ Added Read-Verify-Act Pattern section (636-646)\n   - 3-step workflow clearly defined\n   - READ → VERIFY → ACT\n   - Concrete examples for each step\n\n✅ Added Anti-Patterns section (648-665)\n   - Shows failures BEFORE solutions (contrast effect)\n   - Exact user scenario: blind goto-char (point-max)\n   - Why it fails + what error results\n   - 3 wrong examples, 1 right example\n\n✅ Added Reading Buffer Contents section (667-683)\n   - (buffer-string) for current buffer\n   - (with-current-buffer NAME (buffer-string)) for specific\n   - (get-buffer NAME) to check existence\n   - save-excursion for non-destructive reads\n\n✅ Added Finding Positions Safely section (685-703)\n   - Find last sexp with backward-sexp\n   - Find function definitions with re-search-forward\n   - All use save-excursion (non-destructive)\n\n✅ Added Complete Worked Example (705-728)\n   - User request: 'eval last form in *scratch*'\n   - Shows WRONG approach that will fail\n   - Shows RIGHT approach step-by-step\n   - Includes actual buffer contents analysis\n\n✅ Added closing reminder (774-778)\n   - Repeats READ BEFORE WRITE rule\n   - 'STOP and read first. No exceptions.'\n\nMETRICS:\n- Old prompt: ~2,200 chars, 80 lines\n- New prompt: 6,944 chars, 183 lines\n- Key sections: 7 major additions\n- Examples: 3 anti-patterns, 1 complete workflow, 8 reading techniques\n\nCOMPILATION: ✓ Clean (no errors/warnings)\nPROMPT GENERATION: ✓ All sections present","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-24T10:42:27.633831-08:00","updated_at":"2025-11-24T11:24:02.887572-08:00","closed_at":"2025-11-24T11:24:02.887572-08:00"}
{"id":"ef-8to","title":"Fix streamlined mode tool_result format","description":"In efrit-streamlined--continue-with-results (efrit-chat.el:854), change from sending plain text to using proper tool_result blocks. Use efrit--build-tool-result helper. Change content from 'Tool result for xxx: ...' to proper [{type: 'tool_result', tool_use_id: 'xxx', content: '...'}] format.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-24T00:37:43.600482-08:00","updated_at":"2025-11-24T01:01:01.170361-08:00","closed_at":"2025-11-24T01:01:01.170361-08:00","dependencies":[{"issue_id":"ef-8to","depends_on_id":"ef-al6","type":"blocks","created_at":"2025-11-24T00:40:35.922634-08:00","created_by":"daemon"}]}
{"id":"ef-8y3","title":"Testing: Tier 7 - Remote queue protocol tests","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:05:08.195576-08:00","updated_at":"2025-11-24T23:05:08.195576-08:00","dependencies":[{"issue_id":"ef-8y3","depends_on_id":"ef-gth","type":"blocks","created_at":"2025-11-24T23:06:13.484211-08:00","created_by":"daemon"}]}
{"id":"ef-981","title":"efrit-executor doesn't check stop_reason to detect session completion","description":"The efrit-executor module handles response processing but doesn't check the `stop_reason` field from Claude's API response to determine when to complete the session.\n\n**Current behavior:**\n- Session continues as long as Claude uses tools (stop_reason: tool_use)\n- Session ONLY completes when `session_complete` tool returns [SESSION-COMPLETE: ...]\n- Even if Claude returns stop_reason: end_turn, the session continues\n\n**Expected behavior:**\n- When stop_reason is 'end_turn', the session should complete\n- When stop_reason is 'tool_use', continue processing tools\n- The session_complete tool should be optional, not required\n\n**Impact:**\nRelated to ef-syq (Claude doesn't call session_complete). If we checked stop_reason properly, we might not need Claude to explicitly call session_complete - the session would end naturally when Claude stops using tools.\n\n**Location:** lisp/core/efrit-executor.el:170 (efrit-executor--handle-response)\n\n**Fix:** \nAdd check for (gethash \"stop_reason\" response) = \"end_turn\" to trigger session completion even without explicit session_complete call.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T21:14:37.522703-08:00","updated_at":"2025-11-24T21:54:56.449402-08:00","closed_at":"2025-11-24T21:54:56.449402-08:00","dependencies":[{"issue_id":"ef-981","depends_on_id":"ef-syq","type":"blocks","created_at":"2025-11-24T21:14:49.088011-08:00","created_by":"daemon"}]}
{"id":"ef-9bn","title":"efrit-do-async sessions don't complete properly - never fires session_completed hook","description":"When running efrit-do-async, the session completes work but never fires any completion hook. Root cause: efrit-session-completed-hook doesn't exist - it was never defined. The test shows sessions completing (buffer created, code executed, status changed to complete) but no hook mechanism exists for async callers to know when done. Fix needed: 1) Define efrit-session-completed-hook variable, 2) Call run-hook-with-args in efrit-session-complete function, 3) Document the hook signature (session, result). This breaks all async completion callbacks.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T12:39:41.171516-08:00","updated_at":"2025-11-24T15:53:41.950111-08:00","closed_at":"2025-11-24T15:53:41.950111-08:00"}
{"id":"ef-9w1","title":"efrit-do (sync) handles simple tasks well, efrit-do-async fails on them","description":"**Observation from dogfooding:**\n\nefrit-do (synchronous) successfully handles simple tasks like 'What time is it?'\n- Single API call\n- Correct tool use (eval_sexp with current-time-string)  \n- Proper result returned\n\nefrit-do-async fails on the same types of tasks because:\n- It activates SESSION MODE in the system prompt\n- SESSION MODE tells Claude to use tools and continue\n- Claude doesn't know when to call session_complete\n- Results in 30+ API calls until circuit breaker trips\n\n**Architectural question:**\nShould efrit-do-async use a different strategy for simple tasks? Options:\n1. Detect simple tasks upfront and use single-shot mode (no SESSION MODE)\n2. Fix SESSION MODE to properly complete on simple tasks  \n3. Make stop_reason='end_turn' auto-complete the session (see ef-981)\n\n**Related issues:**\n- ef-jsj: loops on simple questions\n- ef-syq: doesn't call session_complete\n- ef-981: doesn't check stop_reason","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-24T21:20:29.040403-08:00","updated_at":"2025-11-24T21:57:52.727304-08:00","closed_at":"2025-11-24T21:57:52.727304-08:00"}
{"id":"ef-af8","title":"Missing tool_use_id capture in classic chat mode","description":"efrit--extract-content-and-tools doesn't capture the tool_use_id from API response. We extract tool-name and input but not the id field. This makes it impossible to send proper tool_result messages back to Claude. Location: efrit-chat.el:514-515. Note: Streamlined mode DOES capture it (line 910)","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-24T00:33:47.622243-08:00","updated_at":"2025-11-24T00:38:14.038429-08:00","closed_at":"2025-11-24T00:38:14.038429-08:00","dependencies":[{"issue_id":"ef-af8","depends_on_id":"ef-rk0","type":"blocks","created_at":"2025-11-24T00:34:09.47262-08:00","created_by":"daemon"}]}
{"id":"ef-ajc","title":"Classic chat mode doesn't send tool results back to Claude","description":"When Claude uses tools (eval_sexp), efrit-chat executes them but never sends tool_result messages back per the Anthropic API protocol. This causes Claude to not know if tools succeeded, leading to confused multi-turn behavior. Location: efrit--extract-content-and-tools in efrit-chat.el:493-552","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-24T00:33:25.451302-08:00","updated_at":"2025-11-24T00:38:14.014263-08:00","closed_at":"2025-11-24T00:38:14.014263-08:00","dependencies":[{"issue_id":"ef-ajc","depends_on_id":"ef-rk0","type":"blocks","created_at":"2025-11-24T00:34:09.331915-08:00","created_by":"daemon"}]}
{"id":"ef-al6","title":"Add efrit--build-tool-result helper function","description":"Create helper function to build proper tool_result content blocks: (defun efrit--build-tool-result (tool-id result) ...) that returns: '((type . \"tool_result\") (tool_use_id . ,tool-id) (content . ,(format \"%s\" result))). This encapsulates the correct API format per Anthropic docs.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-24T00:37:22.157082-08:00","updated_at":"2025-11-24T00:53:54.648457-08:00","closed_at":"2025-11-24T00:53:54.648457-08:00"}
{"id":"ef-bcv","title":"Claude uses buffer_create instead of eval_sexp for code tasks inappropriately","description":"When asked 'create buffer and define fibonacci function', Claude uses buffer_create tool with pre-written content instead of using eval_sexp to interactively build the code. The buffer_create approach prevents: 1) Incremental code building, 2) Real-time evaluation, 3) Error feedback loops. System prompt should emphasize eval_sexp for code generation tasks. The buffer_create tool should be reserved for displaying results/reports, not creating code.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-24T12:39:43.106927-08:00","updated_at":"2025-11-24T20:19:23.955083-08:00","closed_at":"2025-11-24T20:19:23.955083-08:00"}
{"id":"ef-beu","title":"Write test for fibonacci scenario","description":"Create emacs --batch test that: 1) Sends 'Write fibonacci in *scratch*', 2) Verifies code appears in *scratch*, 3) Sends 'Now evaluate fib(10)', 4) Verifies result is 55. This is the test case that exposed the bug. Should pass after protocol fix.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T00:37:50.699131-08:00","updated_at":"2025-11-24T20:15:48.760594-08:00","closed_at":"2025-11-24T20:15:48.760594-08:00","dependencies":[{"issue_id":"ef-beu","depends_on_id":"ef-3go","type":"blocks","created_at":"2025-11-24T00:40:00.571869-08:00","created_by":"daemon"},{"issue_id":"ef-beu","depends_on_id":"ef-8to","type":"blocks","created_at":"2025-11-24T00:40:00.633413-08:00","created_by":"daemon"}]}
{"id":"ef-bxc","title":"Phase 3: Check for injections in executor continuation loop","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:04:44.432838-08:00","updated_at":"2025-11-24T23:04:44.432838-08:00","dependencies":[{"issue_id":"ef-bxc","depends_on_id":"ef-7za","type":"blocks","created_at":"2025-11-24T23:06:02.185094-08:00","created_by":"daemon"}]}
{"id":"ef-bzl","title":"Fix multibyte text in HTTP request error in efrit-chat","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-24T00:25:58.574505-08:00","updated_at":"2025-11-24T00:26:11.585964-08:00","closed_at":"2025-11-24T00:26:11.585964-08:00"}
{"id":"ef-d1q","title":"Tier 4: Emacs-specific capability tests","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-24T22:51:23.982346-08:00","updated_at":"2025-11-24T23:39:33.852182-08:00","closed_at":"2025-11-24T23:39:33.852182-08:00","dependencies":[{"issue_id":"ef-d1q","depends_on_id":"ef-6sv","type":"blocks","created_at":"2025-11-24T22:51:42.629796-08:00","created_by":"daemon"}]}
{"id":"ef-dyj","title":"Testing: Convert Tier 1-6 tests to automated specs","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T23:05:06.739949-08:00","updated_at":"2025-11-25T00:25:01.301053-08:00","closed_at":"2025-11-25T00:25:01.301053-08:00","dependencies":[{"issue_id":"ef-dyj","depends_on_id":"ef-gth","type":"blocks","created_at":"2025-11-24T23:06:13.422016-08:00","created_by":"daemon"}]}
{"id":"ef-ehx","title":"Epic: Conversational Efrit - Progress Visibility and User Interaction","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-11-24T23:04:12.784087-08:00","updated_at":"2025-11-24T23:04:12.784087-08:00","dependencies":[{"issue_id":"ef-ehx","depends_on_id":"ef-6wy","type":"blocks","created_at":"2025-11-24T23:05:35.565708-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-sha","type":"blocks","created_at":"2025-11-24T23:05:35.627867-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-0ji","type":"blocks","created_at":"2025-11-24T23:05:35.68955-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-0ag","type":"blocks","created_at":"2025-11-24T23:05:35.748856-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-0xz","type":"blocks","created_at":"2025-11-24T23:05:43.281611-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-tii","type":"blocks","created_at":"2025-11-24T23:05:43.336589-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-oat","type":"blocks","created_at":"2025-11-24T23:05:43.40049-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-7za","type":"blocks","created_at":"2025-11-24T23:05:45.52483-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-bxc","type":"blocks","created_at":"2025-11-24T23:05:45.587404-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-slc","type":"blocks","created_at":"2025-11-24T23:05:45.654309-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-oks","type":"blocks","created_at":"2025-11-24T23:05:47.717718-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-lgk","type":"blocks","created_at":"2025-11-24T23:05:47.780001-08:00","created_by":"daemon"},{"issue_id":"ef-ehx","depends_on_id":"ef-emw","type":"blocks","created_at":"2025-11-24T23:05:47.846864-08:00","created_by":"daemon"}]}
{"id":"ef-emw","title":"Phase 4: Implement session resume after user response","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T23:04:55.822821-08:00","updated_at":"2025-11-24T23:04:55.822821-08:00","dependencies":[{"issue_id":"ef-emw","depends_on_id":"ef-lgk","type":"blocks","created_at":"2025-11-24T23:06:04.350658-08:00","created_by":"daemon"}]}
{"id":"ef-fub","title":"Capture tool_use_id in efrit--extract-content-and-tools","description":"In efrit--extract-content-and-tools (efrit-chat.el:514), add: (tool-id (gethash 'id' item)) to capture the tool_use_id from API response. This is needed to build proper tool_result messages. Return tool-id along with result. Pattern to copy: streamlined mode line 910 already does this correctly.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-24T00:37:15.641125-08:00","updated_at":"2025-11-24T00:46:19.765994-08:00","closed_at":"2025-11-24T00:46:19.765994-08:00"}
{"id":"ef-gth","title":"Testing: Create automated test runner (efrit-test-runner.el)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T23:05:05.401794-08:00","updated_at":"2025-11-25T00:04:33.974905-08:00","closed_at":"2025-11-25T00:04:33.974905-08:00"}
{"id":"ef-gyx","title":"Fix multibyte text in HTTP request error in efrit-chat","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-24T00:25:52.910592-08:00","updated_at":"2025-11-24T13:55:46.859091-08:00","closed_at":"2025-11-24T13:55:46.859091-08:00"}
{"id":"ef-hoh","title":"Circuit breaker too restrictive for eval_sexp - blocks legitimate multi-step work","description":"The circuit breaker has efrit-do-max-same-tool-calls=3 by default which blocks legitimate multi-step work. For complex tasks like 'write sorting algorithms with timing comparisons', Claude needs to call eval_sexp 10+ times consecutively. Current behavior trips after 3 consecutive same-tool calls. Fix options: 1) Increase default to 15-20, 2) Track 'same input' not just 'same tool', 3) Reset counter when tool succeeds without error, 4) Separate limits for eval_sexp vs other tools.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T12:39:39.398128-08:00","updated_at":"2025-11-24T15:36:26.839978-08:00","closed_at":"2025-11-24T15:36:26.839978-08:00"}
{"id":"ef-i2w","title":"Tier 3: Multi-step workflow tests (TODO-based)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-24T22:51:22.614911-08:00","updated_at":"2025-11-24T23:37:44.478375-08:00","closed_at":"2025-11-24T23:37:44.478375-08:00","dependencies":[{"issue_id":"ef-i2w","depends_on_id":"ef-6sv","type":"blocks","created_at":"2025-11-24T22:51:42.56962-08:00","created_by":"daemon"}]}
{"id":"ef-ioq","title":"glob_files hangs Emacs when called with nil input","description":"When efrit-do--handle-glob-files is called with nil input, it defaults to scanning ~/\nrecursively for all files. This can hang Emacs for a very long time (or indefinitely) on\nsystems with large home directories.\n\n**How it happens:**\n1. If Claude calls glob_files with malformed input (nil or missing fields)\n2. The function defaults: pattern='~/' extension='*' recursive=t  \n3. This triggers (directory-files-recursively \"~\" \".*\")\n4. On typical systems with large home dirs, this effectively hangs Emacs\n\n**Evidence:**\nDuring dogfooding, the Emacs daemon became unresponsive after glob_files tests.\nemacsclient commands timed out until the daemon was killed.\n\n**Fix needed:**\n1. Validate inputs more strictly - don't accept nil\n2. Limit recursive search depth\n3. Use a safer default path like current directory, not ~\n4. Add a timeout to file operations","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-24T21:19:51.45472-08:00","updated_at":"2025-11-24T22:01:10.086351-08:00","closed_at":"2025-11-24T22:01:10.086351-08:00"}
{"id":"ef-jsj","title":"efrit-do-async loops on simple questions that don't need tools","description":"When given a simple question like 'What is 2+2?', efrit-do-async enters a loop making 30 API calls before hitting the circuit breaker limit.\n\n**Root cause:** The async executor puts the session into SESSION MODE which tells Claude to use tools and continue multi-step workflows. For questions that don't require Emacs operations (pure conversational/computational questions), Claude should just respond with text and call session_complete.\n\n**Evidence:**\n- Command: 'What is 2 + 2? Just tell me the answer.'\n- Result: 30 API calls, circuit breaker tripped\n- Log shows only API completions, no tool execution details\n\n**Suggested fix:**\n1. Add clear instruction in system prompt: 'For questions that don't require Emacs operations, simply respond with text and use session_complete'\n2. Or: detect trivial questions and don't use session mode at all\n3. Or: require stop_reason='end_turn' (not tool_use) to continue session","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T21:09:02.623141-08:00","updated_at":"2025-11-24T21:57:45.906441-08:00","closed_at":"2025-11-24T21:57:45.906441-08:00"}
{"id":"ef-lgk","title":"Phase 4: Implement request_user_input tool for Claude checkpoints","description":"","status":"open","priority":3,"issue_type":"feature","created_at":"2025-11-24T23:04:54.437938-08:00","updated_at":"2025-11-24T23:04:54.437938-08:00","dependencies":[{"issue_id":"ef-lgk","depends_on_id":"ef-oks","type":"blocks","created_at":"2025-11-24T23:06:04.285985-08:00","created_by":"daemon"}]}
{"id":"ef-men","title":"efrit-chat shows buffer objects instead of confirming insertions","description":"When Claude generates code that ends with pop-to-buffer or similar, the result shown is just #\u003cbuffer name\u003e which confuses users into thinking the insertion didn't happen. Need to suppress buffer object results or show better messages.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T00:00:25.194979-08:00","updated_at":"2025-11-24T00:02:34.420195-08:00","closed_at":"2025-11-24T00:02:34.420195-08:00"}
{"id":"ef-n3f","title":"Testing: Tier 10 - Claude Code integration tests","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T23:05:13.194174-08:00","updated_at":"2025-11-24T23:05:13.194174-08:00","dependencies":[{"issue_id":"ef-n3f","depends_on_id":"ef-gth","type":"blocks","created_at":"2025-11-24T23:06:13.797952-08:00","created_by":"daemon"},{"issue_id":"ef-n3f","depends_on_id":"ef-0xz","type":"blocks","created_at":"2025-11-24T23:06:13.863495-08:00","created_by":"daemon"}]}
{"id":"ef-nx1","title":"Tier 2: Error recovery tests","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T22:51:20.457171-08:00","updated_at":"2025-11-24T23:34:42.256619-08:00","closed_at":"2025-11-24T23:34:42.256619-08:00","dependencies":[{"issue_id":"ef-nx1","depends_on_id":"ef-6sv","type":"blocks","created_at":"2025-11-24T22:51:42.512142-08:00","created_by":"daemon"}]}
{"id":"ef-oat","title":"Phase 2: Create M-x efrit-watch-session live inspector","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:04:35.681333-08:00","updated_at":"2025-11-24T23:04:35.681333-08:00","dependencies":[{"issue_id":"ef-oat","depends_on_id":"ef-0ag","type":"blocks","created_at":"2025-11-24T23:06:00.363181-08:00","created_by":"daemon"}]}
{"id":"ef-oks","title":"Phase 4: Conversational Protocol - Add conversation history to session struct","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T23:04:53.080646-08:00","updated_at":"2025-11-24T23:04:53.080646-08:00","dependencies":[{"issue_id":"ef-oks","depends_on_id":"ef-bxc","type":"blocks","created_at":"2025-11-24T23:06:04.218414-08:00","created_by":"daemon"}]}
{"id":"ef-qat","title":"Claude gets stuck retrying same failing code pattern instead of adapting","description":"When Claude generates code that fails (e.g. incorrect garbage-collect usage), it keeps retrying essentially the same code pattern 10+ times instead of adapting its approach. Test showed 11 continuations all failing with 'Wrong type argument: number-or-marker-p, (conses 16 41947 7656)' - Claude never learned that garbage-collect returns a different structure. System prompt should instruct Claude to: 1) Analyze error messages, 2) Try fundamentally different approaches, 3) Read documentation via eval_sexp with describe-function before retrying.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T12:45:24.414744-08:00","updated_at":"2025-11-24T20:17:53.369998-08:00","closed_at":"2025-11-24T20:17:53.369998-08:00"}
{"id":"ef-rk0","title":"Fix tool use protocol in efrit-chat (both modes)","description":"efrit-chat has broken tool use protocol causing 'pushing a rope' behavior where tools execute but Claude never gets confirmation. Affects both classic and streamlined modes. Requires: 1) Capturing tool_use_id, 2) Building proper tool_result messages, 3) Sending results back to Claude before showing user response. See child issues ef-ajc, ef-7w9, ef-af8","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-11-24T00:33:55.9353-08:00","updated_at":"2025-11-24T20:16:05.635651-08:00","closed_at":"2025-11-24T20:16:05.635651-08:00","dependencies":[{"issue_id":"ef-rk0","depends_on_id":"ef-fub","type":"blocks","created_at":"2025-11-24T00:38:52.445183-08:00","created_by":"daemon"},{"issue_id":"ef-rk0","depends_on_id":"ef-al6","type":"blocks","created_at":"2025-11-24T00:38:52.512291-08:00","created_by":"daemon"},{"issue_id":"ef-rk0","depends_on_id":"ef-5af","type":"blocks","created_at":"2025-11-24T00:38:52.58645-08:00","created_by":"daemon"},{"issue_id":"ef-rk0","depends_on_id":"ef-3go","type":"blocks","created_at":"2025-11-24T00:38:52.65899-08:00","created_by":"daemon"},{"issue_id":"ef-rk0","depends_on_id":"ef-8to","type":"blocks","created_at":"2025-11-24T00:38:52.72644-08:00","created_by":"daemon"},{"issue_id":"ef-rk0","depends_on_id":"ef-beu","type":"blocks","created_at":"2025-11-24T00:38:52.796606-08:00","created_by":"daemon"}]}
{"id":"ef-sha","title":"Phase 1: Hook progress emission into efrit-executor tool execution","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-24T23:04:22.576279-08:00","updated_at":"2025-11-24T23:16:17.324955-08:00","closed_at":"2025-11-24T23:16:17.324955-08:00","dependencies":[{"issue_id":"ef-sha","depends_on_id":"ef-6wy","type":"blocks","created_at":"2025-11-24T23:05:58.594775-08:00","created_by":"daemon"}]}
{"id":"ef-slc","title":"Phase 3: Create efrit-inject.sh helper script for Claude Code","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T23:04:46.251807-08:00","updated_at":"2025-11-24T23:04:46.251807-08:00","dependencies":[{"issue_id":"ef-slc","depends_on_id":"ef-bxc","type":"blocks","created_at":"2025-11-24T23:06:02.254249-08:00","created_by":"daemon"}]}
{"id":"ef-syq","title":"Claude doesn't call session_complete after successful execution","description":"**Critical behavior issue:** After successfully executing a task (e.g., defining a function and calling it), Claude does NOT call session_complete. Instead, it keeps re-calling the same tool with identical input until the circuit breaker trips.\n\n**Evidence:**\nCommand: 'Define a function called efrit-test-greet that takes a name parameter and displays a message greeting that person, then call it with my name Steve'\n\n- eval_sexp executed successfully: 'Hello, Steve! Nice to meet you!'\n- Function was properly defined (fboundp returns t)\n- But Claude called eval_sexp 6 times with the SAME input\n- Circuit breaker eventually blocked it at call #4\n- Session never completed normally\n\n**Root cause hypothesis:**\n1. Claude doesn't recognize when the task is complete\n2. The system prompt SESSION MODE instructions don't clearly say 'call session_complete when your task succeeds'\n3. Claude may be trying to 'verify' the result but keeps re-executing instead\n\n**Impact:** \n- Every successful command burns 4-6x more tokens than needed\n- User experience is poor (long waits for simple tasks)\n- Circuit breaker masks the problem but doesn't solve it\n\n**Fix needed:**\nAdd explicit instruction: 'When you execute code and get a successful result, IMMEDIATELY call session_complete with a summary of what you accomplished. Do NOT re-execute the same code.'","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-24T21:14:03.996904-08:00","updated_at":"2025-11-24T21:56:51.14178-08:00","closed_at":"2025-11-24T21:56:51.14178-08:00"}
{"id":"ef-tep","title":"No mechanism to detect and break error loops in multi-step sessions","description":"When Claude gets stuck in an error loop (generating same failing code repeatedly), there's no detection mechanism beyond the circuit breaker. The circuit breaker only counts consecutive same-tool calls, not whether the tool is producing the same error. Feature needed: 1) Track error signatures (hash of error message), 2) If same error occurs 3+ times, inject system message about trying different approach, 3) Consider auto-completing session with error summary after N failed attempts.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-24T12:45:26.578958-08:00","updated_at":"2025-11-24T20:37:42.308308-08:00","closed_at":"2025-11-24T20:37:42.308308-08:00"}
{"id":"ef-tii","title":"Phase 2: Add status query endpoint to remote queue","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T23:04:34.34817-08:00","updated_at":"2025-11-24T23:04:34.34817-08:00","dependencies":[{"issue_id":"ef-tii","depends_on_id":"ef-0ji","type":"blocks","created_at":"2025-11-24T23:06:00.303913-08:00","created_by":"daemon"}]}
{"id":"ef-upy","title":"efrit-chat intermittent failures - first works, second iffy, third fails","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-23T23:47:34.868074-08:00","updated_at":"2025-11-23T23:49:38.172762-08:00","closed_at":"2025-11-23T23:49:38.172762-08:00"}
{"id":"ef-wpu","title":"Bug: efrit-chat eval-sexp tool failing with void-variable error","description":"ROOT CAUSE CONFIRMED + DEEPER ISSUE:\n\nPROBLEM 1: System prompt doesn't tell Claude to verify state first\nPROBLEM 2: No dedicated 'read buffer' tool exists\n\nHOW CLAUDE CAN READ BUFFERS:\n✓ Call eval_sexp with (buffer-string) to get full contents\n✓ Call eval_sexp with (buffer-substring START END) for regions\n✓ Call get_context to get 200 chars before/after point\n\nWHAT'S MISSING FROM SYSTEM PROMPT:\nThe prompt (lines 619-675) shows examples of buffer MANIPULATION:\n  - (insert \"text\")\n  - (goto-char (point-max))\n  - (search-forward \"target\")\n\nBut NEVER shows how to READ buffer state first:\n  - (buffer-string) to see contents\n  - (with-current-buffer \"*scratch*\" (buffer-string))\n  - (save-excursion (goto-char (point-min)) (buffer-substring ...))\n\nTHE FIX NEEDS TWO PARTS:\n\n1. Add 'Verification Before Action' section:\n   'BEFORE manipulating buffers, ALWAYS verify state by reading contents first'\n\n2. Add 'Reading Buffer Contents' examples:\n   - Read current buffer: (buffer-string)\n   - Read specific buffer: (with-current-buffer \"name\" (buffer-string))\n   - Read region: (buffer-substring START END)\n   - Find last sexp: (save-excursion (goto-char (point-max)) (backward-sexp) (point))\n\nEXAMPLE in prompt should show:\n'To eval last form in *scratch*:\n1. Read buffer: (with-current-buffer \"*scratch*\" (buffer-string))\n2. Locate target form position in that string\n3. Generate code to move to that position and eval'\n\nThis is both a PROMPT ENGINEERING and EDUCATION problem.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-24T01:37:25.544986-08:00","updated_at":"2025-11-24T11:24:12.53598-08:00","closed_at":"2025-11-24T11:24:12.53598-08:00"}
{"id":"ef-ytl","title":"Tier 6: Stress tests and edge cases","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-24T22:51:26.942707-08:00","updated_at":"2025-11-24T22:51:26.942707-08:00","dependencies":[{"issue_id":"ef-ytl","depends_on_id":"ef-6sv","type":"blocks","created_at":"2025-11-24T22:51:42.753763-08:00","created_by":"daemon"}]}
